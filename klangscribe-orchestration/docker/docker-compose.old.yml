services:
  # PostgreSQL DB for Dagster's run storage, schedule storange, and event log storage
  dagster-postgres:
    image: postgres:16
    container_name: dagster_postgres
    network_mode: "host"
    environment:
      POSTGRES_USER: ${DAGSTER_POSTGRES_USER:-dagster}
      POSTGRES_PASSWORD: ${DAGSTER_POSTGRES_PASSWORD:-dagster}
      POSTGRES_DB: ${DAGSTER_POSTGRES_DB:-dagster}
      PGPORT: 5433
    volumes:
      - dagster_postgres_data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DAGSTER_POSTGRES_USER:-dagster} -p 5433"]
      interval: 10s
      timeout: 5s
      retries: 5
    
  # Code location server that runs gRPC server to load user code
  dagster-code-location:
    build:
      context: ..
      dockerfile: docker/dagster/Dockerfile_code
    container_name: dagster_code_location
    image: dagster-code-location:latest
    command: dagster api grpc -h 0.0.0.0 -p 4000 -f src/klangscribe_orchestration/definitions.py
    network_mode: "host"
    env_file:
      - ../.env
    volumes:
      - ../pyproject.toml:/opt/dagster/app/pyproject.toml
      - ../uv.lock:/opt/dagster/app/uv.lock
      - ../src:/opt/dagster/app/src
      - ../watch_dir:/mnt/watch_dir
    environment:
      - PYTHONPATH=/opt/dagster/app/src
      - DAGSTER_HOME=/opt/dagster/dagster_home
    depends_on:
      dagster-postgres:
        condition: service_healthy
    restart: unless-stopped

  # Dagster Webserver
  dagster-webserver:
    build:
      context: ..
      dockerfile: docker/dagster/Dockerfile_dagster
    container_name: dagster_webserver
    image: dagster-base:latest
    command: dagster-webserver -h 0.0.0.0 -p 3000 -w /opt/dagster/workspace.yaml
    network_mode: "host"
    env_file:
      - ../.env
    volumes:
      - ../workspace.yaml:/opt/dagster/workspace.yaml
      - ../dagster.yaml:/opt/dagster/dagster_home/dagster.yaml
    environment:
      - DAGSTER_HOME=/opt/dagster/dagster_home
    depends_on:
      - dagster-postgres
      - dagster-code-location
    restart: unless-stopped

  # Dagster Daemon
  dagster-daemon:
    image: dagster-base:latest
    container_name: dagster_daemon
    command: dagster-daemon run -w /opt/dagster/workspace.yaml
    network_mode: "host"
    env_file:
      - ../.env
    volumes:
      - ../workspace.yaml:/opt/dagster/workspace.yaml
      - ../dagster.yaml:/opt/dagster/dagster_home/dagster.yaml
    environment:
      - DAGSTER_HOME=/opt/dagster/dagster_home
    depends_on:
      - dagster-postgres
      - dagster-code-location
    restart: unless-stopped

volumes:
  dagster_postgres_data: